{{- $id := printf "pv-%d" (now.UnixNano) -}}
{{- $page := .Page.GetPage (.Get "page") -}}
{{- if not $page -}}
<strong>preview shortcode error:</strong> page not found: {{ .Get "page" }}
{{- else -}}

<button
  type="button"
  style="
    display:inline-flex;
    align-items:center;
    padding:10px 14px;
    border-radius:10px;
    font-weight:600;
    box-shadow:0 6px 18px rgba(0,0,0,.18);
  "
  data-preview-open="{{ $id }}"
>
  {{ .Inner | markdownify }}
</button>

<div id="{{ $id }}" style="position:fixed; inset:0; z-index:9999; display:none;" data-preview-modal>
  <!-- Backdrop: blur only background page -->
  <div
    style="
      position:absolute;
      inset:0;
      background: rgba(30,30,30,0.55);
      backdrop-filter: blur(14px) saturate(1.05);
      -webkit-backdrop-filter: blur(14px) saturate(1.05);
    "
    data-preview-close="{{ $id }}"
  ></div>

  <!-- Center wrapper -->
  <div
    style="
      position:relative;
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    "
  >
    <!-- Preview card -->
    <div
      data-preview-card
      style="
        width:60vw;
        height:60vh;

        border-radius:22px;
        border:1px solid rgba(57,57,57,0.45);

        overflow:hidden;
        box-shadow:0 30px 80px rgba(0,0,0,0.55);

        background: rgb(30,30,30);
        color: rgba(209,206,206,0.92);
        color-scheme: dark;
      "
    >
      <!-- Header -->
      <div
        style="
          display:flex;
          align-items:center;
          gap:10px;
          padding:12px 14px;
          border-bottom:1px solid rgba(128,128,128,0.25);
        "
      >
        <!-- Mac-style close button -->
        <button
          type="button"
          aria-label="Close preview"
          data-preview-close="{{ $id }}"
          style="
            width:12px;
            height:12px;
            border-radius:999px;
            background:#ff5f57;
            border:1px solid rgba(0,0,0,0.25);
            padding:0;
            cursor:pointer;
          "
          title="Close"
        ></button>

        <div
          style="
            font-weight:700;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
          "
        >
          {{ $page.Title }}
        </div>
      </div>

      <!-- Body -->
      <div
        style="
          height:calc(100% - 49px);
          overflow:auto;
          padding:16px;
        "
      >
        <!-- ✅ FIXED: valid, scoped CSS selectors -->
        <style>
          /* Scope strictly to THIS modal + THIS card */
          #{{ $id }} [data-preview-card] .prose,
          #{{ $id }} [data-preview-card] .prose :where(p, li, blockquote, dd, dt, figcaption) {
            color: rgba(209,206,206,0.92) !important;
          }

          #{{ $id }} [data-preview-card] .prose :where(h1, h2, h3, h4, h5, h6) {
            color: rgba(255,255,255,0.96) !important;
          }

          #{{ $id }} [data-preview-card] .prose a {
            color: rgba(147,197,253,0.95) !important;
            text-decoration: underline;
          }

          #{{ $id }} [data-preview-card] .prose code {
            color: rgba(255,255,255,0.92) !important;
            background: rgba(255,255,255,0.08) !important;
          }

          #{{ $id }} [data-preview-card] .prose pre {
            background: rgba(255,255,255,0.06) !important;
            border: 1px solid rgba(255,255,255,0.10) !important;
          }

          #{{ $id }} [data-preview-card] .prose hr {
            border-color: rgba(255,255,255,0.12) !important;
          }

          /* ✅ Tables */
          #{{ $id }} [data-preview-card] .prose table {
            color: rgba(209,206,206,0.92) !important;
            border-color: rgba(255,255,255,0.14) !important;
          }

          #{{ $id }} [data-preview-card] .prose thead th,
          #{{ $id }} [data-preview-card] .prose th {
            color: rgba(255,255,255,0.95) !important;
            background: rgba(255,255,255,0.06) !important;
            border-bottom-color: rgba(255,255,255,0.18) !important;
          }

          #{{ $id }} [data-preview-card] .prose td {
            color: rgba(209,206,206,0.92) !important;
            border-color: rgba(255,255,255,0.12) !important;
          }

          #{{ $id }} [data-preview-card] .prose tr {
            border-color: rgba(255,255,255,0.10) !important;
          }
        </style>

        <div class="prose max-w-none">
          {{ with $page.Summary }}
            {{ . | safeHTML }}
          {{ else }}
            {{ $page.Content | safeHTML }}
          {{ end }}
        </div>

        <div style="margin-top:14px;">
          <a href="{{ $page.RelPermalink }}" style="text-decoration:underline;">
            Open full page →
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const id = "{{ $id }}";
  const root = document.getElementById(id);
  const card = root?.querySelector("[data-preview-card]");

  function applySize() {
    if (!card) return;
    const landscape = window.innerWidth >= window.innerHeight;

    if (landscape) {
      card.style.width = Math.round(window.innerWidth * 0.60) + "px";
      card.style.height = Math.round(window.innerHeight * 0.60) + "px";
    } else {
      card.style.width = Math.round(window.innerWidth * 0.92) + "px";
      card.style.height = Math.round(window.innerHeight * 0.60) + "px";
    }
  }

  function openModal() {
    root.style.display = "block";
    document.documentElement.classList.add("overflow-hidden");
    applySize();
  }

  function closeModal() {
    root.style.display = "none";
    document.documentElement.classList.remove("overflow-hidden");
  }

  document.addEventListener("click", function (e) {
    if (e.target.closest('[data-preview-open="' + id + '"]')) openModal();
    if (e.target.closest('[data-preview-close="' + id + '"]')) closeModal();
  });

  if (card) {
    card.addEventListener("click", function (e) {
      if (e.target.closest('[data-preview-close="' + id + '"]')) return;
      e.stopPropagation();
    });
  }

  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") closeModal();
  });

  window.addEventListener("resize", function () {
    if (root.style.display === "block") applySize();
  }, { passive: true });
})();
</script>

{{- end -}}